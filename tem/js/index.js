$(function(){"use strict";function e(e){var t={};"feed"===e.index?(t.sideUrl="/reader/GetUserSubscribe",t.feedUrl=1===e.id?"/reader/CustRecom":e.id>1?"/reader/GetContent/site_id/"+e.id:"/reader/Recom"):"site"===e.index?(t.sideUrl="/site/Tags",t.feedUrl=e.tag?"hot"===e.tag?"/site/Hot":"/site/GetTag/name/"+decodeURIComponent(e.tag):"/site/Hot"):"edit"===e.index?(t.sideUrl="/reader/GetUserSubscribe",t.feedUrl="/reader/GetFeedCategory"):(t.sideUrl="/reader/GetUserSubscribe",t.feedUrl="/reader/Recom");var d=e.order?"/order/"+e.order:"";return t.feedUrl+=d,t}function t(e){var t=$("#sidebarTmpl").html(),d=doT.template(t),i=d(e);$(".sidebar").html(i),ui.shareFactory.create($(".sidebar").find(".share-box"),{type:["weixin","qq","qzone","weibo"],text:"设计导航是一款由设计师自己驱动产品，①-参考了RSS阅读器的模式，将设计师经常浏览的工具型网站的内容聚合起来，提供更为便捷的浏览入口。 ②-除了收集了设计师常用网站外，还有用户精选高质量网站不间断更新，轻松把握行业动态。"})}function d(e){var t=$(window).height(),d=0;"feed"===e.index||"edit"===e.index?(d=t-71-61-131-69-80,setTimeout(function(){$(document).find(".category-list").css({"max-height":d+"px"})},10)):"site"===e.index&&(d=t-71-61-68-60-69,setTimeout(function(){$(document).find(".type-list ul").css({"max-height":d+"px"})},10))}function i(){var e=$(".g-footer").offset().left,t=$(document).find(".container").height()+71,d=$(window).height();$(".g-footer").css(d-t>$(".g-footer").height()?{position:"fixed",left:e+"px",right:0,bottom:0}:{position:"static"})}function a(e){$.getJSON(e,{_token:util.getCsrfToken()}).done(function(e){if(1===e.status){var i={};i.index=m.index,i.id=m.id||0,"feed"!==m.index&&"edit"!==m.index&&m.index||(i.recom=[],i.feeds=[]),"site"===m.index&&(i.tags=[],i.currTag=m.tag?decodeURIComponent(m.tag):"hot");for(var a=0,n=e.data.length;n>a;a++)"feed"!==m.index&&"edit"!==m.index&&m.index||("feed"===e.data[a].type?i.recom.push(e.data[a]):(m.id&&1!==m.id?$.each(e.data[a].feeds,function(t,d){parseInt(d.id,10)===m.id&&(e.data[a].active=!0)}):e.data[a].active="设计"===decodeURIComponent(e.data[a].cat_name)?!0:!1,i.feeds.push(e.data[a]))),"site"===m.index&&i.tags.push(e.data[a]);t(i),d(m),"feed"===m.index&&f()}})}function n(e){console.log(e);var t=$("#feedHeaderTmpl").html(),d=doT.template(t),a=d(e),n=$("#feedItemTmpl").html(),o=doT.template(n),r=o(e),s=$("#paginationTmpl").html(),c=doT.template(s),l=c(e),f="";if(f+=a,"feed"===m.index||!m.index){var u=$("#feedOrderTmpl").html(),p=doT.template(u),g=p(e);f+='<div class="feed-main"><div class="feed-container">'+g+r+(e.page.count>1?l:"")+"</div></div>"}if("site"===m.index){var u=$("#feedOrderTmpl").html(),p=doT.template(u),g=p(e),h=$("#feedUserTmpl").html(),v=doT.template(h),x=v(e);f+='<div class="feed-main"><div class="feed-container">'+(m.tag&&"hot"!==m.tag?g:"")+r+(e.peoples.length?x:"")+(e.page.count>1?l:"")+"</div></div>"}if("edit"===m.index){var b=$("#feedSourceTmpl").html(),T=doT.template(b),U=T(e);f+='<div class="feed-main"><div class="feed-container">'+U+"</div></div>"}$(".list-container").html(f),i(),$(document.body).find(".gotop").remove(),$('<a href="javascript:;" class="gotop">gotop</a>').appendTo(document.body)}function o(e){$.getJSON(e,{_token:util.getCsrfToken()}).done(function(e){if(1===e.status){var t={};t.index=m.index,t.orderType=m.order?m.order.split(",")[1]||"desc":"desc","feed"!==m.index&&m.index||(t.feeds=e.data.items,t.order=m.order?m.order.split(",")[0]:"",t.site=!1,t.page={current:e.data.current_page,count:e.data.page_count},t.name=m.id&&1===m.id?"用户推荐":m.id>1?e.data.site:"小云精选"),"site"===m.index&&(t.order=m.order?m.order.split(",")[0]:"",t.site=!0,m.tag&&"hot"!==m.tag?(t.feeds=e.data.links,t.currTag=decodeURIComponent(e.data.currTag.name),t.peoples=[],t.page={current:e.data.page,count:e.data.pageCount}):(t.currTag="热门排行",t.feeds=e.data.sites,t.peoples=e.data.peoples,t.page={current:1,count:1})),"edit"===m.index&&(t.name="编辑订阅源",t.feedSource=e.data,t.page={current:1,count:1}),n(t),"edit"===m.index&&l()}})}function r(t){t>=0&&(util.setHashObject({id:t}),m.id=t);var d=e(m);o(d.feedUrl)}function s(t){util.setHashObject({tag:t}),m.tag=t;var d=e(m);o(d.feedUrl)}function c(e){o(e)}function l(){$.getJSON(g.sideUrl,{_token:util.getCsrfToken()}).done(function(e){if(1===e.status){var t=e.data,d=[];$.each(t,function(e,t){t.feeds?$.each(t.feeds,function(e,t){d.push(parseInt(t.id,10))}):d.push(parseInt(t.id,10))}),$(document).find(".feed-source-item").each(function(){var e=$(this),t=parseInt(e.data("id"),10),i=e.find("a");$.inArray(t,d)>=0&&(i.removeClass("attention"),i.html("取消关注"),e.prop("draggable",!1),e.css({cursor:"default"}))})}})}function f(){if(window.localStorage&&"undefined"!=typeof JSON&&"function"==typeof JSON.parse){var e=window.localStorage.getItem("reader_feed_count");return e=e?JSON.parse(e):{},void $(document).find(".sidebar .feed-list-item").each(function(){var t=$(this),d=t.data("id"),i=t.data("count"),a=e[d]?e[d]:0,n=parseInt(i,10)-parseInt(a,10);n>0&&a>=0?t.find(".feed-update").text(n):t.find(".feed-update").remove()})}return void $(document).find(".sidebar li").find(".feed-update").remove()}function u(e,t){var d=t.parents(".feed-source-item");$.post(h,e).done(function(e){1===e.status&&(t.removeClass().html("取消关注"),d.prop("draggable",!1),d.css({cursor:"default"}),a(g.sideUrl))})}function p(e,t){var d=t.parents(".feed-source-item");$.post(v,e).done(function(e){1===e.status&&(t.addClass("attention").html('<i class="icon icon-plus"></i>关注'),d.prop("draggable",!0),d.css({cursor:"move"}),a(g.sideUrl))})}var m=util.parseHashString();util.checkLogin().done(function(e){util.login=e}).fail(function(){"edit"===m.index&&(location.href="/#!index/feed")}),(!m.index||$.inArray(m.index,["feed","site","edit"])<0)&&(util.setHashObject({index:"feed"}),m.index="feed");var g=e(m);a(g.sideUrl),o(g.feedUrl),$(document).on("click",".filter-list a",function(){var t=$(this),d=t.data("order"),i=t.data("type");i="desc",util.setHashObject({order:d+","+i}),m.order=d+","+i;var a=e(m);o(a.feedUrl)}),$(document).on("click","#prevPage",function(){var t=$(this),d=parseInt(t.data("current"),10)-1;if(!t.hasClass("disabled")){var i=util.parseHashString(),a=e(i);"feed"===i.index?c(a.feedUrl+"/page/"+d):"site"===i.index&&c(a.feedUrl+"/page/"+d),$("html, body").animate({scrollTop:0},300)}}),$(document).on("click","#nextPage",function(){var t=$(this),d=parseInt(t.data("current"),10)+1;if(!t.hasClass("disabled")){var i=util.parseHashString(),a=e(i);"feed"===i.index?c(a.feedUrl+"/page/"+d):"site"===i.index&&c(a.feedUrl+"/page/"+d),$("html, body").animate({scrollTop:0},300)}}),$(document).on("click","#submitPage",function(){var t=$(this),d=parseInt(t.data("count"),10),i=parseInt($(document).find("#gotoPage").val(),10);if(i>d||1>i)return void ui.tips({content:"<p>非法页码</p>",delay:800,onClose:function(){$(document).find("#gotoPage").focus()}});var a=util.parseHashString(),n=e(a);"feed"===a.index?c(n.feedUrl+"/page/"+i):"site"===a.index&&c(n.feedUrl+"/page/"+i),$("html, body").animate({scrollTop:0},300)}),$(document).on("click",".feed-source-item a",function(){var e=$(this),t={site_id:e.data("feed-id"),catid:e.data("catid"),url:e.data("feed-url"),_token:util.getCsrfToken()};e.hasClass("attention")?u(t,e):p(t,e)}),$(document).on("click",".feed-unattention",function(e){e.stopPropagation();var t=$(this),d={site_id:t.data("id"),_token:util.getCsrfToken()};$.post(v,d).done(function(e){1===e.status&&(t.parent().remove(),o(g.feedUrl))})});var h="/reader/AddFeedSite",v="/reader/RemoveFeedSite";$(document).on("click",".sidebar li",function(){var e=$(this);("feed"===m.index||"edit"===m.index)&&parseInt(e.data("id"),10)>=0&&(util.setHashObject({index:"feed"}),m.index="feed",r(e.data("id")),a(g.sideUrl)),"site"===m.index&&e.data("tag")&&s(decodeURIComponent(e.data("tag")))}),$(document).on("click",".recom-list li, .feed-list li",function(){var e=$(this),t=e.data("id");if(e.find(".feed-update").remove(),window.localStorage&&"undefined"!=typeof JSON&&"function"==typeof JSON.parse){var d=e.data("count"),i=window.localStorage.getItem("reader_feed_count");i=i?JSON.parse(i):{},i[t]=d,window.localStorage.setItem("reader_feed_count",JSON.stringify(i))}$(document).find(".sidebar li").removeClass("current"),$(document).find(".sidebar .feed-edit").removeClass("actived"),e.addClass("current"),e.parent().hasClass("recom-list")&&$(document).find(".category-item").removeClass("actived"),$("html, body").animate({scrollTop:0},300)}),$(document).on("click",".hot-sites li, .type-list li",function(){var e=$(this);$(document).find(".sidebar li").removeClass("actived"),e.addClass("actived"),$("html, body").animate({scrollTop:0},300)}),$(window).resize(function(){d(m)}),$(document).on("click",".category-name",function(){var e=$(this),t=e.parent(),d=t.find(".feed-list");t.hasClass("actived")?(d.slideUp(),t.removeClass("actived")):(t.siblings("li").removeClass("actived"),t.siblings("li").find(".feed-list").slideUp(),t.addClass("actived"),d.slideDown())}),$(window).on("scroll",function(){var e=$(window).scrollTop();e>200?$(document).find(".gotop").fadeIn():$(document).find(".gotop").fadeOut()}),$(document).on("click",".gotop",function(){$("html, body").animate({scrollTop:0},300)}),$(document).on("click",".recom-feed",function(){var e,t=parseInt($(this).data("id"),10);$(document).find(".category-list").find("li").each(function(){var d=parseInt($(this).data("id"),10);d===t&&(e=$(this))}),e&&1===e.length?e.trigger("click"):$(document).find("#feed-edit").trigger("click")})});